# ====================================================================
# │ 一键构建 v8a 发行版APK · 自动签名 · 无水印 · GitHub Actions │
# ====================================================================
# │ 说明:                                                            │
# │ 1. 将此文件保存为 .github/workflows/build-v8a.yml                  │
# │ 2. 无需设置任何 Secrets 或签名信息                               │
# │ 3. 在 Actions 页面手动点击 "Run workflow" 即可构建                 │
# ====================================================================

name: Build v8a Release APK (Auto-Signed, No Watermark)

on:
  workflow_dispatch:

jobs:
  build-android-release-v8a:
    runs-on: ubuntu-latest

    steps:
      # 第 1 步: 签出代码
      - name: 1. Checkout Code
        uses: actions/checkout@v4

      # 第 2 步: 设置 Java 环境
      - name: 2. Setup Java Environment
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: "17"
          cache: 'gradle'

      # 第 3 步: 在云端自动生成一个临时签名文件
      - name: 3. Create Temporary Keystore
        run: |
          keytool -genkey -v \
            -keystore android/app/upload-keystore.jks \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload \
            -storepass android \
            -keypass android \
            -dname "CN=, OU=, O=, L=, S=, C="

      # [核心修正 1] 动态创建 key.properties 文件来引用上面的临时签名
      - name: 4. Create key.properties file
        run: |
          echo "storeFile=app/upload-keystore.jks" > android/key.properties
          echo "storePassword=android" >> android/key.properties
          echo "keyPassword=android" >> android/key.properties
          echo "keyAlias=upload" >> android/key.properties

      # 第 5 步: 设置 Flutter 环境
      - name: 5. Setup Flutter Environment
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      # 第 6 步: 安装项目依赖
      - name: 6. Get Flutter Packages
        run: flutter pub get

      # [核心修正 2] 使用干净的 flutter build 命令，它会自动读取 key.properties
      - name: 7. Build Android arm64-v8a Release APK
        run: |
          flutter build apk --release \
            --target-platform android-arm64 \
            --build-name=1.0.0 \
            --build-number=$(($GITHUB_RUN_NUMBER + 10))

      # 第 8 步: 上传构建好的 release APK
      - name: 8. Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: v8a-release-apk
          path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk