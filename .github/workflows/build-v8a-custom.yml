name: Build v8a Release APK (Fixed)

on:
  workflow_dispatch:
  push:
    branches: [ "master", "main" ]

jobs:
  build-android-release-v8a:
    runs-on: ubuntu-latest
    
    steps:
      - name: âœ… Checkout Code
        uses: actions/checkout@v4

      # 1. é…ç½® Java + Gradle ç¼“å­˜
      - name: âœ… Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: "17"
          cache: 'gradle'

      # 2. é…ç½® Flutter + SDK ç¼“å­˜
      - name: âœ… Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'

      # 3. è‡ªåŠ¨ç”Ÿæˆç­¾å (ä½ çš„ç‹¬å®¶ç§˜æ–¹)
      - name: âœ… Create Signing Configuration
        run: |
          KEYSTORE_FILE="${GITHUB_WORKSPACE}/android/app/upload-keystore.jks"
          
          keytool -genkey -v \
            -keystore "${KEYSTORE_FILE}" \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -alias upload \
            -storepass android \
            -keypass android \
            -dname "CN=GitHub Actions, OU=CI, O=PureLive, L=Cloud, S=Auto, C=US"
          
          cat > android/key.properties << EOF
          storeFile=${KEYSTORE_FILE}
          storePassword=android
          keyPassword=android
          keyAlias=upload
          EOF
          
          echo "âœ… Keystore created at: ${KEYSTORE_FILE}"

      - name: âœ… Get Dependencies
        run: flutter pub get

      - name: âœ… Build Split APKs (arm64-v8a)
        run: |
          flutter build apk --release \
            --split-per-abi \
            --target-platform android-arm64 \
            --build-name=1.0.0 \
            --build-number=$((GITHUB_RUN_NUMBER + 10))

      - name: âœ… Verify APKs
        run: |
          echo "ðŸ“¦ Generated APK files:"
          ls -lh build/app/outputs/flutter-apk/*.apk

      - name: ðŸ“¦ Upload arm64-v8a APK Only
        uses: actions/upload-artifact@v4
        with:
          name: pure-live-arm64-v8a-release
          path: build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          if-no-files-found: error
